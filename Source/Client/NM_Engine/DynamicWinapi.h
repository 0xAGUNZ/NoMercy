#pragma once
#include "WinAPI_Typedefs.h"
#include "Windows_Structs.h"
#include "NtApiWrapper.h"
#include <ReflectiveDLLRefresher/src/ReflectiveLoader.h>

typedef struct _WINAPI_MODULE_TABLE
{
	HMODULE hBaseModule;
	HMODULE hKernel32;
	HMODULE hNtdll;
	HMODULE hUser32;
	HMODULE hPsapi;
	HMODULE hDbghelp;
	HMODULE hKernelbase;
	HMODULE hPython;
	HMODULE hAdvapi32;
	HMODULE hWininet;
	HMODULE hWinsta;
	HMODULE hShlwapi;
	HMODULE hShell32;
	HMODULE hCrypt32;
	HMODULE hWs2_32;
	HMODULE hIphlpapi;
	HMODULE hMpr;
	HMODULE hWintrust;
	HMODULE hDnsapi;
	HMODULE hOle32;
	HMODULE hGdiPlus;
	HMODULE hGdi32;
	HMODULE hEvtApi;
	HMODULE hUserEnv;
}WINAPI_MODULE_TABLE, *PWINAPI_MODULE_TABLE;

typedef struct _WINAPI_API_TABLE
{
	lpGetProcAddress GetProcAddress;
	lpGetProcAddress GetProcAddress_o;
	lpGetModuleHandleA GetModuleHandleA;
	lpGetModuleHandleA GetModuleHandleA_o;
	lpLoadLibraryA LoadLibraryA;

	lpIsDebuggerPresent IsDebuggerPresent;
	lpAllocConsole AllocConsole;
	lplstrcmpA lstrcmpA;
	lpGetWindowsDirectoryA GetWindowsDirectoryA;
	lpSleep Sleep;
	lpNtWriteVirtualMemory NtWriteVirtualMemory;
	lpWinStationTerminateProcess WinStationTerminateProcess;
	lpOutputDebugString OutputDebugStringA;
	lpCreateToolhelp32Snapshot CreateToolhelp32Snapshot;
	lpProcess32First Process32FirstW;
	lpProcess32Next Process32NextW;
	lpModule32First Module32FirstW;
	lpModule32Next Module32NextW;
	lpCharUpperBuffA CharUpperBuffA;
	lpMessageBoxA MessageBoxA;
	lpNtQueryInformationProcess NtQueryInformationProcess;
	lpNtQueryInformationThread NtQueryInformationThread;
	lpNtQuerySystemInformation NtQuerySystemInformation;
	lpZwSetInformationThread ZwSetInformationThread;
	lpCheckRemoteDebuggerPresent CheckRemoteDebuggerPresent;
	lpExitThread ExitThread;
	lpGetCurrentProcessId GetCurrentProcessId;
	lpVirtualFree VirtualFree;
	lpVirtualProtect VirtualProtect;
	lpVirtualAlloc VirtualAlloc;
	lpCreateFile CreateFileA;
	lpSetUnhandledExceptionFilter SetUnhandledExceptionFilter;
	lpCreateThread CreateThread;
	lpGetVersionEx GetVersionExA;
	lpWriteProcessMemory WriteProcessMemory;
	lpGetAdaptersInfo GetAdaptersInfo;
	lpGetComputerName GetComputerNameA;
	lpGetVolumeInformation GetVolumeInformationA;
	lpGetDriveType GetDriveTypeA;
	lpLocalAlloc LocalAlloc;
	lpGetModuleFileName GetModuleFileNameA;
	lpGetThreadContext GetThreadContext;
	lpWaitForSingleObject WaitForSingleObject;
	lpResumeThread ResumeThread;
	lpCloseHandle CloseHandle;
	lpGetDeviceDriverBaseName GetDeviceDriverBaseNameA;
	lpEnumDeviceDrivers EnumDeviceDrivers;
	lpGetTickCount GetTickCount;
	lpEnumWindows EnumWindows;
	lpGetLastError GetLastError;
	lpGetUserName GetUserNameA;
	lpShellExecute ShellExecuteA;
	lpGetModuleBaseNameA GetModuleBaseNameA;
	lpSetLastError SetLastError;
	lpCallNextHookEx CallNextHookEx;
	lpSetWindowsHookEx SetWindowsHookExA;
	lpNtResumeProcess NtResumeProcess;
	lpAddVectoredExceptionHandler AddVectoredExceptionHandler;
	lpVirtualQuery VirtualQuery;
	lpMessageBoxTimeout MessageBoxTimeout;
	lpNtClose NtClose;
	lpNtSetInformationDebugObject NtSetInformationDebugObject;
	lpNtRemoveProcessDebug NtRemoveProcessDebug;
	lpFormatMessage FormatMessageA;
	lpMultiByteToWideChar MultiByteToWideChar;
	lpWideCharToMultiByte WideCharToMultiByte;
	lpCreateProcessA CreateProcessA;
	lpGetStartupInfoA GetStartupInfoA;
	lpGetExitCodeProcess GetExitCodeProcess;
	lpPostQuitMessage PostQuitMessage;
	lpOpenProcess OpenProcess;
	lpGetCurrentThreadId GetCurrentThreadId;
	lpGetModuleInformation GetModuleInformation;
	lpGetMappedfilename GetMappedFileNameA;
	lpGetModuleHandleExW GetModuleHandleExW;
	lpFreeLibrary FreeLibrary;
	lpGetModuleHandleW GetModuleHandleW;
	lpNtCreateThreadEx NtCreateThreadEx;
	lpCallWindowProcA CallWindowProcA;
	lpFindWindowExA FindWindowExA;
	lpGetWindowThreadProcessId GetWindowThreadProcessId;
	lpIsWindowVisible IsWindowVisible;
	lpGetClassNameA GetClassNameA;
	lpGetWindowTextA GetWindowTextA;
	lpSetWindowLongA SetWindowLongA;
	lpThread32First Thread32First;
	lpThread32Next Thread32Next;
	lpOpenThread OpenThread;
	lpNtDuplicateObject NtDuplicateObject;
	lpNtQueryObject NtQueryObject;
	lpGetFileSize GetFileSize;
	lpFindFirstFileA FindFirstFileA;
	lpFindNextFileA FindNextFileA;
	lpSetFileAttributesA SetFileAttributesA;
	lpRemoveDirectoryA RemoveDirectoryA;
	lpDeleteFileA DeleteFileA;
	lpGetFileAttributesA GetFileAttributesA;
	lpFindClose FindClose;
	lpLookupPrivilegeValueA LookupPrivilegeValueA;
	lpLookupPrivilegeValueW LookupPrivilegeValueW;
	lpAdjustTokenPrivileges AdjustTokenPrivileges;
	lpOpenProcessToken OpenProcessToken;
	lpNtSetDebugFilterState NtSetDebugFilterState;
	lpWNetGetProviderNameA WNetGetProviderNameA;
	lpNtTerminateProcess NtTerminateProcess;
	lpGetSystemInfo GetSystemInfo;
	lpCreateFileMappingA CreateFileMappingA;
	lpMapViewOfFile MapViewOfFile;
	lpUnmapViewOfFile UnmapViewOfFile;
	lpReadProcessMemory ReadProcessMemory;
	lpAllocateAndInitializeSid AllocateAndInitializeSid;
	lpGetTokenInformation GetTokenInformation;
	lpGlobalAlloc GlobalAlloc;
	lpInitializeAcl InitializeAcl;
	lpAddAccessDeniedAce AddAccessDeniedAce;
	lpAddAccessAllowedAce AddAccessAllowedAce;
	lpSetSecurityInfo SetSecurityInfo;
	lpFreeSid FreeSid;
	lpQueryFullProcessImageNameA QueryFullProcessImageNameA;
	lpGetForegroundWindow GetForegroundWindow;
	lpTerminateThread TerminateThread;
	lpSendMessageA SendMessageA;
	lpSetThreadContext SetThreadContext;
	lpSuspendThread SuspendThread;
	lpGetThreadId GetThreadId;
	lpBlockInput BlockInput;
	lpGetWindowModuleFileNameA GetWindowModuleFileNameA;
	lpRemoveVectoredExceptionHandler RemoveVectoredExceptionHandler;
	lpNtQueryVirtualMemory NtQueryVirtualMemory;
	lpPeekMessageA PeekMessageA;
	lpGetMessageA GetMessageA;
	lpTranslateMessage TranslateMessage;
	lpDispatchMessageA DispatchMessageA;
	lpUnhookWindowsHookEx UnhookWindowsHookEx;
	lpSHGetSpecialFolderPathA SHGetSpecialFolderPathA;
	lpFreeLibraryAndExitThread FreeLibraryAndExitThread;
	lpNtUnmapViewOfSection NtUnmapViewOfSection;
	lpEndTask EndTask;
	lpDebugBreak DebugBreak;
	lpGetModuleHandleExA GetModuleHandleExA;
	lpReadFile ReadFile;
	lpNtSetInformationProcess NtSetInformationProcess;
	lpNtAllocateVirtualMemory NtAllocateVirtualMemory;
	lpGetShellWindow GetShellWindow;
	lpCreateFileW CreateFileW;
	lpCryptCATAdminCalcHashFromFileHandle CryptCATAdminCalcHashFromFileHandle;
	lpCryptCATAdminAcquireContext CryptCATAdminAcquireContext;
	lpCryptCATAdminEnumCatalogFromHash CryptCATAdminEnumCatalogFromHash;
	lpCryptCATAdminReleaseContext CryptCATAdminReleaseContext;
	lpCryptCATCatalogInfoFromContext CryptCATCatalogInfoFromContext;
	lpEnumProcessModules EnumProcessModules;
	lpGetModuleFileNameExA GetModuleFileNameExA;
	lpRtlGetVersion RtlGetVersion;
	lpVerifyVersionInfoW VerifyVersionInfoW;
	lpVerSetConditionMask VerSetConditionMask;
	lpCsrGetProcessId CsrGetProcessId;
	lpGetWindowLongA GetWindowLongA;
	lpInitializeCriticalSection InitializeCriticalSection;
	lpEnterCriticalSection EnterCriticalSection;
	lpLeaveCriticalSection LeaveCriticalSection;
	lpDeleteCriticalSection DeleteCriticalSection;
	lpGetProcessId GetProcessId;
	lpGetProcessImageFileNameA GetProcessImageFileNameA;
	lpGetLogicalDriveStringsA GetLogicalDriveStringsA;
	lpGetSystemMetrics GetSystemMetrics;
	lpRtlAdjustPrivilege RtlAdjustPrivilege;
	lpEnumProcesses EnumProcesses;
	lpOpenThreadToken OpenThreadToken;
	lpGetModuleFileNameW GetModuleFileNameW;
	lpGetDeviceDriverFileNameA GetDeviceDriverFileNameA;
	lpOpenSCManagerA OpenSCManagerA;
	lpEnumServicesStatusA EnumServicesStatusA;
	lpCloseServiceHandle CloseServiceHandle;
	lpToolhelp32ReadProcessMemory Toolhelp32ReadProcessMemory;
	lpOpenEventA OpenEventA;
	lpLocalFree LocalFree;
	lpSetEntriesInAclA SetEntriesInAclA;
	lpSetPriorityClass SetPriorityClass;
	lpBuildExplicitAccessWithNameA BuildExplicitAccessWithNameA;
	lpConvertStringSecurityDescriptorToSecurityDescriptorA ConvertStringSecurityDescriptorToSecurityDescriptorA;
	lpSetKernelObjectSecurity SetKernelObjectSecurity;
	lpCoInitialize CoInitialize;
	lpCoUninitialize CoUninitialize;
	lpInternetOpenA InternetOpenA;
	lpInternetOpenUrlA InternetOpenUrlA;
	lpHttpQueryInfoA HttpQueryInfoA;
	lpInternetCloseHandle InternetCloseHandle;
	lpInternetReadFile InternetReadFile;
	lpWSAStartup WSAStartup;
	lpgethostbyname gethostbyname;
	lpWSACleanup WSACleanup;
	lpWSAGetLastError WSAGetLastError;
	lpinet_ntoa inet_ntoa;
	lpGetFileTime GetFileTime;
	lpGetWindowRect GetWindowRect;
	lpGetDesktopWindow GetDesktopWindow;
	lpGetDC GetDC;
	lpCreateCompatibleDC CreateCompatibleDC;
	lpBitBlt BitBlt;
	lpCreateCompatibleBitmap CreateCompatibleBitmap;
	lpSelectObject SelectObject;
	lpCheckTokenMembership CheckTokenMembership;
	lpGetTempPathA GetTempPathA;
	lpGetTempFileNameA GetTempFileNameA;
	lpQueryWorkingSet QueryWorkingSet;
	lpRtlImageNtHeader RtlImageNtHeader;
	lpZwOpenDirectoryObject ZwOpenDirectoryObject;
	lpZwClose ZwClose;
	lpZwQueryDirectoryObject ZwQueryDirectoryObject;
	lpRtlInitUnicodeString RtlInitUnicodeString;
	lpDeviceIoControl DeviceIoControl;
	lpGetThreadPriority GetThreadPriority;
	lpSetThreadPriority SetThreadPriority;
	lpInternetConnectA InternetConnectA;
	lpHttpOpenRequestA HttpOpenRequestA;
	lpHttpAddRequestHeadersA HttpAddRequestHeadersA;
	lpHttpSendRequestExA HttpSendRequestExA;
	lpInternetWriteFile InternetWriteFile;
	lpHttpEndRequestA HttpEndRequestA;
	lpNtProtectVirtualMemory NtProtectVirtualMemory;
	lpVirtualProtectEx VirtualProtectEx;
	lpCoInitializeEx CoInitializeEx;
	lpCoInitializeSecurity CoInitializeSecurity;
	lpCoCreateInstance CoCreateInstance;
	lpCoSetProxyBlanket CoSetProxyBlanket;
	lpSetTimer SetTimer;
	lpKillTimer KillTimer;
	lpRtlComputeCrc32 RtlComputeCrc32;
	lpNtRaiseHardError NtRaiseHardError;
	lpGetWindowInfo GetWindowInfo;
	lpCommandLineToArgvW CommandLineToArgvW;
	lpGetCommandLineW GetCommandLineW;
	lpNtGetNextThread NtGetNextThread;
	lpNtGetNextProcess NtGetNextProcess;
	lpProcessIdToSessionId ProcessIdToSessionId;
	lpCreateMutexA CreateMutexA;
	lpSetHandleInformation SetHandleInformation;
	lpSetErrorMode SetErrorMode;
	lpIsWow64Process IsWow64Process;
	lpRegOpenKeyExA RegOpenKeyExA;
	lpRegQueryValueExA RegQueryValueExA;
	lpRegCloseKey RegCloseKey;
	lpNtSuspendProcess NtSuspendProcess;
	lpNtResumeThread NtResumeThread;
	lpNtGetContextThread NtGetContextThread;
	lpNtSetContextThread NtSetContextThread;
	lpNtReadVirtualMemory NtReadVirtualMemory;
	lpNtWaitForSingleObject NtWaitForSingleObject;
	lpVirtualAllocEx VirtualAllocEx;
	lpGetConsoleWindow GetConsoleWindow;
	lpShowWindow ShowWindow;
	lpQueryWorkingSetEx QueryWorkingSetEx;
	lpNtAdjustPrivilegesToken NtAdjustPrivilegesToken;
	lpNtOpenProcessToken NtOpenProcessToken;
	lpOpenMutexA OpenMutexA;
	lpInternetCheckConnectionA InternetCheckConnectionA;
	lpFtpPutFileA FtpPutFileA;
	lpGetNativeSystemInfo GetNativeSystemInfo;
	lpGetWindow GetWindow;
	lpEvtCreateRenderContext EvtCreateRenderContext;
	lpEvtQuery EvtQuery;
	lpEvtNext EvtNext;
	lpEvtRender EvtRender;
	lpEvtOpenPublisherMetadata EvtOpenPublisherMetadata;
	lpEvtClose EvtClose;
	lpGlobalFree GlobalFree;
	lpRtlAllocateHeap RtlAllocateHeap;
	lpRtlFreeHeap RtlFreeHeap;
	lpLdrLoadDll LdrLoadDll;
	lpCreateRemoteThread CreateRemoteThread;
	lpVirtualQueryEx VirtualQueryEx;
	lpNtCreateDebugObject NtCreateDebugObject;
	lpNtDebugActiveProcess NtDebugActiveProcess;
	lpRtlAddAccessDeniedAce RtlAddAccessDeniedAce;
	lpRtlAddAccessAllowedAce RtlAddAccessAllowedAce;
	lpRtlImageDirectoryEntryToData RtlImageDirectoryEntryToData;
	lpWow64DisableWow64FsRedirection Wow64DisableWow64FsRedirection;
	lpWow64RevertWow64FsRedirection Wow64RevertWow64FsRedirection;
	lpRtlCreateQueryDebugBuffer RtlCreateQueryDebugBuffer;
	lpRtlDestroyQueryDebugBuffer RtlDestroyQueryDebugBuffer;
	lpRtlQueryProcessDebugInformation RtlQueryProcessDebugInformation;
	lpLdrShutdownProcess LdrShutdownProcess;
	lpNtCreateSection NtCreateSection;
	lpNtMapViewOfSection NtMapViewOfSection;
	lpRtlAcquirePrivilege RtlAcquirePrivilege;
	lpNtCreateSemaphore NtCreateSemaphore;
	lpNtOpenSemaphore NtOpenSemaphore;
	lpNtQuerySemaphore NtQuerySemaphore;
	lpRtlAllocateAndInitializeSid RtlAllocateAndInitializeSid;
	lpRtlCreateUserThread RtlCreateUserThread;
	lpNtCreateFile NtCreateFile;
	lpNtOpenProcess NtOpenProcess;
	lpNtOpenThread NtOpenThread;
	lpRtlCreateProcessParametersEx RtlCreateProcessParametersEx;
	lpNtWow64ReadVirtualMemory64 NtWow64ReadVirtualMemory64;
	lpNtWow64QueryInformationProcess64 NtWow64QueryInformationProcess64;
	lpRegisterWaitForSingleObject RegisterWaitForSingleObject;
	lpRtlNtStatusToDosError RtlNtStatusToDosError;
	lpNtOpenThreadToken NtOpenThreadToken;
	lpNtQueryInformationToken NtQueryInformationToken;
	lpWinStationSendMessageW WinStationSendMessageW;
	lpNtFlushInstructionCache NtFlushInstructionCache;
	lpNtWow64AllocateVirtualMemory64 NtWow64AllocateVirtualMemory64;
	lpNtWow64WriteVirtualMemory64 NtWow64WriteVirtualMemory64;
	lpNtSuspendThread NtSuspendThread;
	lpNtTerminateThread NtTerminateThread;
	lpGetProcessHeap GetProcessHeap;
	lpNtDelayExecution NtDelayExecution;
	lpNtFreeVirtualMemory NtFreeVirtualMemory;
	lpNtSystemDebugControl NtSystemDebugControl;
	lpRtlCaptureStackBackTrace RtlCaptureStackBackTrace;
	lpNtSetSystemInformation NtSetSystemInformation;
	lpRegGetValueA RegGetValueA;
	lpQueryFullProcessImageNameW QueryFullProcessImageNameW;
	lpSetWinEventHook SetWinEventHook;
	lpUnhookWinEvent UnhookWinEvent;
	lpIsWindow IsWindow;
	lpGetWindowDisplayAffinity GetWindowDisplayAffinity;
	lpSetWindowDisplayAffinity SetWindowDisplayAffinity;
	lpRtlCreateTimerQueue RtlCreateTimerQueue;
	lpRtlDeleteTimerQueue RtlDeleteTimerQueue;
	lpRtlCreateTimer RtlCreateTimer;
	lpRtlDeleteTimer RtlDeleteTimer;
	lpGetSystemDirectoryA GetSystemDirectoryA;
	lpGetNamedPipeServerProcessId GetNamedPipeServerProcessId;
	lpNtYieldExecution NtYieldExecution;
	lpCreateEventA CreateEventA;
	lpResetEvent ResetEvent;
	lpSetEvent SetEvent;
	lpDuplicateTokenEx DuplicateTokenEx;
	lpCreateEnvironmentBlock CreateEnvironmentBlock;
	lpCreateProcessAsUserA CreateProcessAsUserA;
	lpDestroyEnvironmentBlock DestroyEnvironmentBlock;
	lpHeapSetInformation HeapSetInformation;
	lpCloseWindow CloseWindow;
}WINAPI_API_TABLE, *PWINAPI_API_TABLE;


class CDynamicWinapi
{
	public:
		CDynamicWinapi();
		~CDynamicWinapi();

		bool	Initialize(LPDWORD pdwErrorStep);
		bool	HasInitialized();
		void	Finalize();

		bool BindBaseAPIs();
		bool BindModules();	
		bool BindAPIs();

		bool	IsValidHandle(HANDLE hTarget);
		bool	SafeCloseHandle(HANDLE hTarget);
		bool	CheckModulesIntegrity(std::string * pszModuleName, LPDWORD dpwErrorStep);
		bool	PatchWow64Redirection();

		PVOID		GetModuleAddressFromName(const wchar_t* c_wszName, bool bIsCompleteCheck = true);
		std::string	GetModuleNameFromAddress(DWORD_PTR dwAddress, bool bFullName = true);
		bool		IsLoadedAddress(DWORD_PTR dwAddress);
		bool		DestroyEntrypoint(DWORD_PTR dwAddress);
		LPVOID		GetLdrModule(DWORD_PTR dwAddress);
		LPVOID		FindModuleFromAddress(DWORD_PTR dwAddress);

		auto		NTHelper() { return m_ntHelper; };
		
	protected:
		void BindAPIs_1();
		void BindAPIs_2();
		void BindAPIs_3();
		void BindAPIs_4();

		HMODULE GetPythonHandle();

	private:
		bool					m_bHasInitialized;
		std::shared_ptr <CNT>	m_ntHelper;
};

extern std::shared_ptr <WINAPI_MODULE_TABLE>	g_winapiModuleTable;
extern std::shared_ptr <WINAPI_API_TABLE>		g_winapiApiTable;

